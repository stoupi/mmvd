generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String          @id
  email         String          @unique
  emailVerified Boolean         @default(false)
  name          String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  image         String?
  affiliation   String?
  avatarUrl     String?
  firstName     String?
  isActive      Boolean         @default(true)
  lastName      String?
  permissions   AppPermission[] @default([])
  centreId      String?
  title         String?
  locale        String?
  accounts      Account[]
  proposalsAsPi Proposal[]      @relation("ProposalPi")
  reviews       Review[]
  sessions      Session[]
  centre        Centre?         @relation(fields: [centreId], references: [id])
  reviewTopics  MainArea[]      @relation("ReviewerTopics")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Centre {
  id            String          @id @default(cuid())
  code          String          @unique
  name          String
  address       String?
  postalCode    String?
  city          String?
  countryCode   String
  latitude      Float?
  longitude     Float?
  patientCount  Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  proposals     Proposal[]
  users         User[]
  investigators Investigator[]

  @@index([countryCode])
  @@index([code])
}

model Investigator {
  id           String           @id @default(cuid())
  firstName    String
  lastName     String
  role         InvestigatorRole
  displayOrder Int
  photoUrl     String?
  centreId     String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  centre       Centre           @relation(fields: [centreId], references: [id], onDelete: Cascade)

  @@index([centreId])
  @@index([role])
}

model SubmissionWindow {
  id                    String       @id @default(cuid())
  name                  String       @unique
  submissionOpenAt      DateTime
  submissionCloseAt     DateTime
  reviewStartAt         DateTime?
  reviewDeadlineDefault DateTime?
  responseDeadline      DateTime?
  nextWindowOpensAt     DateTime?
  status                WindowStatus @default(UPCOMING)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  proposals             Proposal[]

  @@index([status])
}

model MainArea {
  id          String     @id @default(cuid())
  label       String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  color       String?
  proposals   Proposal[]
  reviewers   User[]     @relation("ReviewerTopics")
}

model Proposal {
  id                   String           @id @default(cuid())
  title                String
  submissionWindowId   String
  mainAreaId           String
  piUserId             String
  status               ProposalStatus   @default(DRAFT)
  createdAt            DateTime         @default(now())
  submittedAt          DateTime?
  updatedAt            DateTime         @updatedAt
  isDeleted            Boolean          @default(false)
  adjustmentCovariates String?
  analysisDescription  String?
  analysisTypes        String[]         @default([])
  competingWork        Json
  dataBaseline         Boolean          @default(false)
  dataBiological       Boolean          @default(false)
  dataCMR              Boolean          @default(false)
  dataCT               Boolean          @default(false)
  dataClinicalFollowup Boolean          @default(false)
  dataCoreLab          Boolean          @default(false)
  dataHospitalFollowup Boolean          @default(false)
  dataRHC              Boolean          @default(false)
  dataStressEcho       Boolean          @default(false)
  dataTOE              Boolean          @default(false)
  dataTTE              Boolean          @default(false)
  dataTTEFollowup      Boolean          @default(false)
  exclusionCriteria    String?
  inclusionCriteria    String?
  literaturePosition   String
  mainExposure         String
  primaryEndpoint      String
  primaryObjective     String
  scientificBackground String
  secondaryEndpoints   String[]         @default([])
  secondaryObjectives  String[]         @default([])
  secondaryTopics      String[]         @default([])
  studyPopulation      String
  subgroupAnalyses     String?
  targetJournals       String[]         @default([])
  centreId             String
  centre               Centre           @relation(fields: [centreId], references: [id])
  mainArea             MainArea         @relation(fields: [mainAreaId], references: [id])
  piUser               User             @relation("ProposalPi", fields: [piUserId], references: [id])
  submissionWindow     SubmissionWindow @relation(fields: [submissionWindowId], references: [id])
  reviews              Review[]

  @@index([submissionWindowId])
  @@index([piUserId])
  @@index([centreId])
  @@index([status])
  @@index([isDeleted])
}

model Review {
  id               String             @id @default(cuid())
  proposalId       String
  reviewerId       String
  assignedAt       DateTime           @default(now())
  deadline         DateTime
  completedAt      DateTime?
  status           ReviewStatus       @default(ASSIGNED)
  isLate           Boolean            @default(false)
  decision         ReviewDecision?
  overlap          OverlapAssessment?
  overlapDetails   String?
  commentsForPI    String?
  commentsForAdmin String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  isDeleted        Boolean            @default(false)
  proposal         Proposal           @relation(fields: [proposalId], references: [id])
  reviewer         User               @relation(fields: [reviewerId], references: [id])

  @@unique([proposalId, reviewerId])
  @@index([reviewerId])
  @@index([status])
  @@index([isDeleted])
}

enum AppPermission {
  SUBMISSION
  REVIEWING
  ADMIN
}

enum WindowStatus {
  UPCOMING
  OPEN
  REVIEW
  RESPONSE
  CLOSED
}

enum ProposalStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  PRIORITIZED
}

enum ReviewStatus {
  ASSIGNED
  COMPLETED
}

enum ReviewDecision {
  ACCEPT
  REJECT
  REVISE
}

enum OverlapAssessment {
  NO
  PARTIAL
  MAJOR
}

enum InvestigatorRole {
  PI
  CO_INVESTIGATOR
}
